<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مواقيت الصلاة - عمّان</title>
    
    <!-- === الإضافات الجديدة لـ PWA === -->
    <meta name="theme-color" content="#0D1B2A">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-1024.png">
    <link rel="apple-touch-icon" href="icon-1024.png">
    <!-- ============================= -->
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0D1B2A;
            --card-color: #1B263B;
            --text-color: #E0E1DD;
            --primary-color: #E1C56E;
            --disabled-color: #4A5568;
        }
        /* --- تعديل هيكلي: ضمان ثبات الصفحة ومنع التمرير --- */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }
        /* --- تعديل هيكلي: تحويل الحاوية إلى flex column لتوزيع المساحة --- */
        .container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            padding-top: 20px; /* إعادة المسافة العلوية للعنوان */
            box-sizing: border-box;
        }
        header {
            flex-shrink: 0; /* منع انكماش الهيدر */
        }
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            line-height: 1.7;
        }
        #current-date-header {
            color: var(--primary-color);
            font-size: 1rem;
            margin: 0 0 1.5rem 0; /* المسافة بين التاريخ والمواقيت */
            min-height: 1.2em;
        }
        .prayer-times-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            flex-shrink: 0; /* منع انكماش المواقيت */
        }
        .prayer-card {
            background-color: var(--card-color);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .prayer-card h2 { margin: 0 0 8px; font-size: 1rem; color: var(--primary-color); font-weight: 600; }
        .prayer-card p { margin: 0; font-size: 1.4rem; font-weight: bold; }
        .prayer-card.active { border-color: var(--primary-color); box-shadow: 0 0 15px rgba(225, 197, 110, 0.3); }
        .next-prayer-container { 
            background-color: var(--card-color); 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 1.5rem; 
            flex-shrink: 0; /* منع انكماش العداد */
        }
        #next-prayer-name { color: var(--primary-color); font-size: 1.1rem; font-weight: 600; }
        #timer { margin: 0; font-size: 1.9rem; font-weight: bold; }
        
        /* --- تعديل هيكلي: تثبيت الأسهم في الأسفل --- */
        .navigation-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto; /* السحر كله هنا: يدفع العنصر لأسفل */
            padding-top: 1.5rem; /* مسافة بسيطة من المحتوى الذي قد يقترب منه */
        }
        .nav-arrow {
            background: var(--card-color);
            border: none;
            color: var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 5px;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-arrow:hover:not(:disabled) { background-color: #2a3b52; }
        .nav-arrow:disabled { color: var(--disabled-color); background-color: var(--card-color); cursor: not-allowed; opacity: 0.5; }
    </style>
</head>
<body>

    <!-- تعديل هيكلي: تم تبسيط الهيكل بإزالة وسم main -->
    <div class="container">
        <header>
            <h1>مواقيت الصلاة لمدينة<br>عمّان</h1>
            <p id="current-date-header">... يتم الآن تحميل المواقيت</p>
        </header>

        <div class="prayer-times-grid">
            <div class="prayer-card" id="fajr-card"><h2>الفجر</h2><p id="fajr-time">--:--</p></div>
            <div class="prayer-card" id="sunrise-card"><h2>الشروق</h2><p id="sunrise-time">--:--</p></div>
            <div class="prayer-card" id="dhuhr-card"><h2>الظهر</h2><p id="dhuhr-time">--:--</p></div>
            <div class="prayer-card" id="asr-card"><h2>العصر</h2><p id="asr-time">--:--</p></div>
            <div class="prayer-card" id="maghrib-card"><h2>المغرب</h2><p id="maghrib-time">--:--</p></div>
            <div class="prayer-card" id="isha-card"><h2>العشاء</h2><p id="isha-time">--:--</p></div>
        </div>
        
        <div class="next-prayer-container" id="countdown-container">
            <span id="next-prayer-name"></span>
            <p id="timer"></p>
        </div>
        
        <div class="navigation-controls">
            <button id="prev-day-btn" class="nav-arrow" aria-label="اليوم السابق">&lt;</button>
            <button id="next-day-btn" class="nav-arrow" aria-label="اليوم التالي">&gt;</button>
        </div>
    </div>

    <script>
    // --- قسم الجافاسكريبت لم يتغير ---
    document.addEventListener('DOMContentLoaded', async () => {
        async function fetchAndParsePrayerData() {
            const url = 'https://iofahmawi.github.io/salat/amman-2025.csv';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();
                return new Map(
                    csvText.trim().split('\n').slice(1).map(line => {
                        const [date, fajr, sunrise, dhuhr, asr, maghrib, isha] = line.split(',');
                        return [date, { FAJR: fajr, SUNRISE: sunrise, DHUHR: dhuhr, ASR: asr, MAGHRIB: maghrib, ISHA: isha }];
                    })
                );
            } catch (error) {
                console.error("Error fetching prayer times:", error);
                document.getElementById('current-date-header').textContent = 'فشل تحميل المواقيت. يرجى التحقق من اتصال الإنترنت.';
                return null;
            }
        }

        const prayerData = await fetchAndParsePrayerData();
        if (!prayerData) return;

        const prayerNames = { FAJR: 'الفجر', SUNRISE: 'الشروق', DHUHR: 'الظهر', ASR: 'العصر', MAGHRIB: 'المغرب', ISHA: 'العشاء' };
        const elements = {
            fajrTime: document.getElementById('fajr-time'), sunriseTime: document.getElementById('sunrise-time'),
            dhuhrTime: document.getElementById('dhuhr-time'), asrTime: document.getElementById('asr-time'),
            maghribTime: document.getElementById('maghrib-time'), ishaTime: document.getElementById('isha-time'),
            fajrCard: document.getElementById('fajr-card'), sunriseCard: document.getElementById('sunrise-card'),
            dhuhrCard: document.getElementById('dhuhr-card'), asrCard: document.getElementById('asr-card'),
            maghribCard: document.getElementById('maghrib-card'), ishaCard: document.getElementById('isha-card'),
            nextPrayerName: document.getElementById('next-prayer-name'), timer: document.getElementById('timer'),
            countdownContainer: document.getElementById('countdown-container'), nextDayBtn: document.getElementById('next-day-btn'),
            prevDayBtn: document.getElementById('prev-day-btn'),
            currentDateHeader: document.getElementById('current-date-header')
        };
        
        let displayedDate = new Date();
        let countdownInterval = null;

        function getDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatTimeForDisplay(timeStr, prayerKey) {
            if (!timeStr) return '--:--';
            const isAm = prayerKey === 'FAJR' || prayerKey === 'SUNRISE';
            const ampm = isAm ? 'ص' : 'م';
            
            let [hour, minute] = timeStr.split(':');
            let h = parseInt(hour, 10);
            if (!isAm && h > 12) h -= 12; 
            if (h === 0) h = 12;

            return `${h}:${minute} ${ampm}`;
        }

        function updateUIForDate(date) {
            clearInterval(countdownInterval);
            const dateKey = getDateString(date);
            const dayData = prayerData.get(dateKey);

            elements.currentDateHeader.textContent = date.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            Object.keys(prayerNames).forEach(key => {
                const element = elements[`${key.toLowerCase()}Time`];
                if (element) {
                    element.textContent = dayData ? formatTimeForDisplay(dayData[key], key) : '--:--';
                }
            });

            const isToday = (new Date()).toDateString() === date.toDateString();
            
            elements.countdownContainer.style.visibility = isToday ? 'visible' : 'hidden';
            document.querySelectorAll('.prayer-card').forEach(c => c.classList.remove('active'));

            if (isToday) {
                startCountdown();
                countdownInterval = setInterval(startCountdown, 1000);
            }
            
            updateNavigation(date);
        }

        function updateNavigation(date) {
            const dateArray = Array.from(prayerData.keys());
            const firstDate = new Date(dateArray[0]); firstDate.setHours(0,0,0,0);
            const lastDate = new Date(dateArray[dateArray.length - 1]); lastDate.setHours(0, 0, 0, 0);
            const currentDay = new Date(date); currentDay.setHours(0, 0, 0, 0);
            
            elements.prevDayBtn.disabled = currentDay <= firstDate;
            elements.nextDayBtn.disabled = currentDay >= lastDate;
        }

        function startCountdown() {
            const now = new Date();
            const gracePeriod = 30 * 60 * 1000;
            const dateKey = getDateString(now);
            const dayData = prayerData.get(dateKey);
            if (!dayData) return;

            const prayerTimesToday = Object.keys(prayerNames).map(name => {
                const time = dayData[name];
                if (!time) return null;
                const [h, m] = time.split(':');
                
                let hour24 = parseInt(h, 10);
                const isAm = name === 'FAJR' || name === 'SUNRISE';
                if (!isAm && hour24 < 12) {
                    hour24 += 12;
                }
                
                return { name, nameAr: prayerNames[name], card: elements[`${name.toLowerCase()}Card`], date: new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour24, m) };
            }).filter(Boolean);

            let currentPrayer = null, nextPrayer = null;
            for (const prayer of prayerTimesToday) {
                if (now >= prayer.date) {
                    currentPrayer = prayer;
                }
                if (now < prayer.date && !nextPrayer) {
                    nextPrayer = prayer;
                }
            }

            let prayerToHighlight = null;
            if (!currentPrayer && nextPrayer) {
                prayerToHighlight = nextPrayer;
            } else if (currentPrayer && nextPrayer) {
                const timeSinceCurrentPrayer = now - currentPrayer.date;
                if (timeSinceCurrentPrayer < gracePeriod) {
                    prayerToHighlight = currentPrayer;
                } else {
                    prayerToHighlight = nextPrayer;
                }
            } else if (currentPrayer && !nextPrayer) {
                prayerToHighlight = currentPrayer;
            }

            document.querySelectorAll('.prayer-card').forEach(c => c.classList.remove('active'));
            if (prayerToHighlight && prayerToHighlight.card) {
                prayerToHighlight.card.classList.add('active');
            }

            if (nextPrayer) {
                elements.nextPrayerName.textContent = `متبقي على أذان ${nextPrayer.nameAr}`;
                elements.timer.textContent = getCountdownString(nextPrayer.date - now);
            } else {
                elements.nextPrayerName.textContent = 'انتهت صلوات اليوم';
                elements.timer.textContent = 'تقبل الله';
            }
        }
        
        function getCountdownString(diff) {
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        elements.nextDayBtn.addEventListener('click', () => {
            displayedDate.setDate(displayedDate.getDate() + 1);
            updateUIForDate(displayedDate);
        });
        elements.prevDayBtn.addEventListener('click', () => {
            displayedDate.setDate(displayedDate.getDate() - 1);
            updateUIForDate(displayedDate);
        });

        updateUIForDate(displayedDate);
    });
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
    
</body>
</html>