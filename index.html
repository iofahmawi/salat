<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مواقيت الصلاة</title>
    <meta name="theme-color" content="#0D1B2A">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-1024.png">
    <link rel="apple-touch-icon" href="icon-1024.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-color:#0D1B2A;--card-color:#1B263B;--text-color:#E0E1DD;--primary-color:#E1C56E;--disabled-color:#4A5568}html,body{height:100%;margin:0;overflow:hidden}body{font-family:'Cairo',sans-serif;background-color:var(--bg-color);color:var(--text-color);padding:15px;box-sizing:border-box;display:flex;justify-content:center}.container{width:100%;max-width:800px;height:100%;text-align:center;display:flex;flex-direction:column;padding-top:7.5px;padding-bottom:30px;box-sizing:border-box}header{flex-shrink:0}header h1{font-size:1.8rem;margin-bottom:5px;line-height:1.7;cursor:pointer;-webkit-tap-highlight-color:transparent}#current-date-header{color:var(--primary-color);font-size:1rem;margin:0 0 1.5rem 0;min-height:1.2em}.prayer-times-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;flex-shrink:0}.prayer-card{background-color:var(--card-color);padding:15px;border-radius:8px;border:2px solid transparent;transition:border-color .3s,box-shadow .3s}.prayer-card h2{margin:0 0 8px;font-size:1rem;color:var(--primary-color);font-weight:600}
        
        /* Change 1: Prayer times font size */
        .prayer-card p{margin:0;font-size:1.45rem;font-weight:bold}
        
        .next-prayer-highlight { border-color: var(--primary-color); box-shadow: 0 0 8px rgba(225, 197, 110, 0.4); }
        .countdown-card{grid-column:1 / -1; margin-top: 10px;}
        
        /* Change 2: Countdown NUMBERS font size */
        .countdown-card p{margin:0;font-size:1.60rem;font-weight:bold}

        /* Change 3 (New): Special smaller font size for TEXT in the countdown area */
        .countdown-text {
            font-size: 1.2rem !important; /* Use !important to ensure it overrides the default */
            font-weight: 600;
        }

        .navigation-controls{display:flex;justify-content:space-between;align-items:center;margin-top:auto;padding-top:1.5rem}.nav-arrow{background:var(--card-color);border:none;color:var(--primary-color);border-radius:50%;width:50px;height:50px;font-size:2rem;font-weight:bold;cursor:pointer;transition:background-color .3s;display:flex;justify-content:center;align-items:center;padding-bottom:5px;-webkit-tap-highlight-color:transparent}.nav-arrow:hover:not(:disabled){background-color:#2a3b52}.nav-arrow:disabled{color:var(--disabled-color);background-color:var(--card-color);cursor:not-allowed;opacity:.5}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:1000}.modal-content{background-color:var(--bg-color);border:2px solid var(--card-color);padding:20px;border-radius:10px;text-align:center;width:90%;max-width:320px}.modal-content h2{margin-top:0;margin-bottom:20px;font-size:1.5rem;color:var(--primary-color)}.city-selection-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}.city-btn{background-color:var(--card-color);color:var(--text-color);border:1px solid var(--card-color);border-radius:8px;font-family:'Cairo',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;transition:background-color .3s,border-color .3s;-webkit-tap-highlight-color:transparent;aspect-ratio:1/1;padding:5px;display:flex;justify-content:center;align-items:center;text-align:center}.city-btn:hover{background-color:#2a3b52;border-color:var(--primary-color)}
    </style>
</head>
<body>
    <div id="city-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>اختر محافظتك</h2>
            <div id="city-selection" class="city-selection-grid">
                 <button class="city-btn" data-city="amman" data-name="عمّان">عمّان</button>
                <button class="city-btn" data-city="zarqa" data-name="الزرقاء">الزرقاء</button>
                <button class="city-btn" data-city="balqa" data-name="البلقاء">البلقاء</button>
                <button class="city-btn" data-city="madaba" data-name="مادبا">مادبا</button>
                <button class="city-btn" data-city="irbid" data-name="إربد">إربد</button>
                <button class="city-btn" data-city="mafraq" data-name="المفرق">المفرق</button>
                <button class="city-btn" data-city="ajloun" data-name="عجلون">عجلون</button>
                <button class="city-btn" data-city="jerash" data-name="جرش">جرش</button>
                <button class="city-btn" data-city="karak" data-name="الكرك">الكرك</button>
                <button class="city-btn" data-city="tafilah" data-name="الطفيلة">الطفيلة</button>
                <button class="city-btn" data-city="ma'an" data-name="معان">معان</button>
                <button class="city-btn" data-city="aqaba" data-name="العقبة">العقبة</button>
            </div>
        </div>
    </div>
    <div class="container">
        <header>
            <h1 id="city-header">مواقيت الصلاة</h1>
            <p id="current-date-header">... الرجاء اختيار المدينة</p>
        </header>
        <div class="prayer-times-grid">
            <div class="prayer-card" id="fajr-card"><h2>الفجر</h2><p id="fajr-time">--:--</p></div>
            <div class="prayer-card" id="sunrise-card"><h2>الشروق</h2><p id="sunrise-time">--:--</p></div>
            <div class="prayer-card" id="dhuhr-card"><h2>الظهر</h2><p id="dhuhr-time">--:--</p></div>
            <div class="prayer-card" id="asr-card"><h2>العصر</h2><p id="asr-time">--:--</p></div>
            <div class="prayer-card" id="maghrib-card"><h2>المغرب</h2><p id="maghrib-time">--:--</p></div>
            <div class="prayer-card" id="isha-card"><h2>العشاء</h2><p id="isha-time">--:--</p></div>
            <div class="prayer-card countdown-card">
                <h2 id="countdown-title">الوقت المتبقي</h2>
                <p id="countdown-timer">--:--:--</p>
            </div>
        </div>
        <div class="navigation-controls">
            <button id="prev-day-btn" class="nav-arrow" aria-label="اليوم السابق">&lt;</button>
            <button id="next-day-btn" class="nav-arrow" aria-label="اليوم التالي">&gt;</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('city-modal');
        const citySelectionContainer = document.getElementById('city-selection');
        const cityHeader = document.getElementById('city-header');
        let prayerData = null;
        let displayedDate = new Date();
        const allPrayerKeys = ['FAJR', 'SUNRISE', 'DHUHR', 'ASR', 'MAGHRIB', 'ISHA'];
        const prayerKeysForCountdown = ['FAJR', 'DHUHR', 'ASR', 'MAGHRIB', 'ISHA'];
        const prayerNames = {FAJR: 'الفجر', SUNRISE: 'الشروق', DHUHR: 'الظهر', ASR: 'العصر', MAGHRIB: 'المغرب', ISHA: 'العشاء'};
        let countdownInterval = null;

        const elements = {
            fajrTime: document.getElementById('fajr-time'), 
            sunriseTime: document.getElementById('sunrise-time'),
            dhuhrTime: document.getElementById('dhuhr-time'), 
            asrTime: document.getElementById('asr-time'),
            maghribTime: document.getElementById('maghrib-time'), 
            ishaTime: document.getElementById('isha-time'),
            nextDayBtn: document.getElementById('next-day-btn'),
            prevDayBtn: document.getElementById('prev-day-btn'),
            currentDateHeader: document.getElementById('current-date-header'),
            countdownTitle: document.getElementById('countdown-title'),
            countdownTimer: document.getElementById('countdown-timer')
        };

        async function fetchAndParsePrayerData(cityId) {
            const url = `https://iofahmawi.github.io/salat/governorates/${cityId}-2025.csv`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network response was not ok`);
                const csvText = await response.text();
                return new Map(
                    csvText.trim().split('\n').slice(1).map(line => {
                        const [date, fajr, sunrise, dhuhr, asr, maghrib, isha] = line.split(',');
                        return [date, { FAJR: fajr, SUNRISE: sunrise, DHUHR: dhuhr, ASR: asr, MAGHRIB: maghrib, ISHA: isha }];
                    })
                );
            } catch (error) {
                console.error("Error fetching prayer times:", error);
                elements.currentDateHeader.textContent = 'فشل تحميل المواقيت.';
                return null;
            }
        }
        
        function parseTimeTo24Hour(timeStr, prayerKey) {
            let [hours, minutes] = timeStr.split(':').map(num => parseInt(num, 10));
            if (['DHUHR', 'ASR', 'MAGHRIB', 'ISHA'].includes(prayerKey) && hours < 12) {
                hours += 12;
            }
            return { hours, minutes };
        }

        async function initializeCity(cityId, cityName) {
            cityHeader.innerHTML = `مواقيت الصلاة لمحافظة<br>${cityName}`;
            elements.currentDateHeader.textContent = '... يتم الآن تحميل المواقيت';
            prayerData = await fetchAndParsePrayerData(cityId);
            if (prayerData) {
                displayedDate = new Date();
                updateUIForDate(displayedDate);
            }
        }

        function getDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function updateUIForDate(date) {
            if (!prayerData) return;
            const dateKey = getDateString(date);
            const dayData = prayerData.get(dateKey);
            const weekday = date.toLocaleDateString('ar-EG', { weekday: 'long' });
            const day = date.getDate();
            const month = date.toLocaleDateString('ar-EG', { month: 'long' });
            const year = date.getFullYear();
            elements.currentDateHeader.textContent = `${weekday}، ${day} ${month} ${year}`;

            allPrayerKeys.forEach(key => {
                const elementKey = `${key.toLowerCase()}Time`;
                const element = elements[elementKey];
                const timeStr = dayData && dayData[key];
                if (element && timeStr) {
                    const { hours, minutes } = parseTimeTo24Hour(timeStr, key);
                    let displayHours = hours % 12;
                    if (displayHours === 0) { displayHours = 12; }
                    const period = (key === 'FAJR' || key === 'SUNRISE') ? 'ص' : 'م';
                    element.textContent = `${displayHours}:${String(minutes).padStart(2, '0')} ${period}`;
                } else if (element) {
                    element.textContent = '--:--';
                }
            });
            startCountdown(date);
            updateNavigation(date);
        }
        
        function startCountdown(date) {
            if (countdownInterval) clearInterval(countdownInterval);
            const prayerCardElements = document.querySelectorAll('.prayer-times-grid .prayer-card:not(.countdown-card)');

            countdownInterval = setInterval(() => {
                const now = new Date();
                if (now.toDateString() !== date.toDateString()) {
                    elements.countdownTitle.textContent = 'الوقت المتبقي';
                    elements.countdownTimer.textContent = 'غير متوفر حاليا';
                    elements.countdownTimer.classList.add('countdown-text'); // Apply smaller font for text
                    prayerCardElements.forEach(card => card.classList.remove('next-prayer-highlight'));
                    return;
                }

                const dateKey = getDateString(date);
                const dayData = prayerData.get(dateKey);
                if (!dayData) return;

                let nextPrayerName = null;
                let nextPrayerTime = null;
                let nextPrayerKey = null;

                for (const key of prayerKeysForCountdown) {
                    const prayerTimeStr = dayData[key];
                    if (prayerTimeStr) {
                        const { hours, minutes } = parseTimeTo24Hour(prayerTimeStr, key);
                        const prayerTime = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hours, minutes);
                        if (prayerTime > now) {
                            nextPrayerName = prayerNames[key];
                            nextPrayerTime = prayerTime;
                            nextPrayerKey = key;
                            break; 
                        }
                    }
                }
                
                prayerCardElements.forEach(card => card.classList.remove('next-prayer-highlight'));
                if (nextPrayerTime) {
                    elements.countdownTimer.classList.remove('countdown-text'); // Use large font for numbers
                    const diff = nextPrayerTime - now;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    elements.countdownTitle.textContent = `متبقي على صلاة ${nextPrayerName}`;
                    elements.countdownTimer.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    const cardId = nextPrayerKey.toLowerCase() + '-card';
                    const nextPrayerCard = document.getElementById(cardId);
                    if (nextPrayerCard) {
                        nextPrayerCard.classList.add('next-prayer-highlight');
                    }
                } else {
                    elements.countdownTitle.textContent = 'انتهت صلوات اليوم';
                    elements.countdownTimer.textContent = 'تقبل الله';
                    elements.countdownTimer.classList.add('countdown-text'); // Apply smaller font for text
                }
            }, 1000);
        }

        function updateNavigation(date) {
            if (!prayerData || prayerData.size === 0) {
                elements.prevDayBtn.disabled = true;
                elements.nextDayBtn.disabled = true;
                return;
            }
            const dateArray = Array.from(prayerData.keys());
            const firstDate = new Date(dateArray[0]); firstDate.setHours(0,0,0,0);
            const lastDate = new Date(dateArray[dateArray.length - 1]); lastDate.setHours(0, 0, 0, 0);
            const currentDay = new Date(date); currentDay.setHours(0, 0, 0, 0);
            elements.prevDayBtn.disabled = currentDay <= firstDate;
            elements.nextDayBtn.disabled = currentDay >= lastDate;
        }
        
        citySelectionContainer.addEventListener('click', e => {
            const btn = e.target.closest('.city-btn');
            if (btn) {
                const cityId = btn.dataset.city;
                const cityName = btn.dataset.name;
                localStorage.setItem('selectedCityId', cityId);
                localStorage.setItem('selectedCityName', cityName);
                modal.style.display = 'none';
                initializeCity(cityId, cityName);
            }
        });

        cityHeader.addEventListener('click', () => { modal.style.display = 'flex'; });
        elements.nextDayBtn.addEventListener('click', () => { if (!prayerData) return; displayedDate.setDate(displayedDate.getDate() + 1); updateUIForDate(displayedDate); });
        elements.prevDayBtn.addEventListener('click', () => { if (!prayerData) return; displayedDate.setDate(displayedDate.getDate() - 1); updateUIForDate(displayedDate); });

        const savedCityId = localStorage.getItem('selectedCityId');
        const savedCityName = localStorage.getItem('selectedCityName');
        if (savedCityId && savedCityName) {
            initializeCity(savedCityId, savedCityName);
        } else {
            modal.style.display = 'flex';
        }
    });
    </script>
    <script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered.'), err => console.log('SW registration failed: ', err)); }); }
    </script>
</body>
</html>